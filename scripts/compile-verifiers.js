const solc = require('solc');
const fs = require('fs');
const path = require('path');

const verifiersDir = path.join(__dirname, '../contracts/verifiers');
const outputFile = path.join(__dirname, '../lib/web3/verifier-bytecodes.ts');

const verifiers = [
  { name: 'MerkleAirdropVerifier', file: 'MerkleAirdropVerifier.sol' },
  { name: 'SealedBidVerifier', file: 'sealed_bidVerifier.sol' },
  { name: 'MastermindVerifier', file: 'mastermindVerifier.sol' },
  { name: 'MixerDemoVerifier', file: 'mixer_demoVerifier.sol' },
  { name: 'PrivateMembershipVerifier', file: 'private_membershipVerifier.sol' },
];

let output = '// Auto-generated verifier bytecodes\n';
output += '// Generated by scripts/compile-verifiers.js\n\n';

for (const verifier of verifiers) {
  const filePath = path.join(verifiersDir, verifier.file);
  const source = fs.readFileSync(filePath, 'utf8');

  // Find contract name in the source
  const contractMatch = source.match(/contract\s+(\w+)/);
  const contractName = contractMatch ? contractMatch[1] : 'Groth16Verifier';

  const input = {
    language: 'Solidity',
    sources: {
      [verifier.file]: {
        content: source,
      },
    },
    settings: {
      outputSelection: {
        '*': {
          '*': ['abi', 'evm.bytecode.object'],
        },
      },
      optimizer: {
        enabled: true,
        runs: 200,
      },
    },
  };

  console.log(`Compiling ${verifier.name}...`);

  const compiled = JSON.parse(solc.compile(JSON.stringify(input)));

  if (compiled.errors) {
    const errors = compiled.errors.filter(e => e.severity === 'error');
    if (errors.length > 0) {
      console.error(`Errors in ${verifier.file}:`, errors);
      continue;
    }
  }

  const contract = compiled.contracts[verifier.file][contractName];
  const bytecode = contract.evm.bytecode.object;
  const abi = contract.abi;

  output += `export const ${verifier.name.toUpperCase()}_BYTECODE = "0x${bytecode}" as \`0x\${string}\`;\n\n`;
  output += `export const ${verifier.name.toUpperCase()}_ABI = ${JSON.stringify(abi, null, 2)} as const;\n\n`;

  console.log(`  - Bytecode length: ${bytecode.length} chars`);
  console.log(`  - ABI functions: ${abi.filter(a => a.type === 'function').length}`);
}

fs.writeFileSync(outputFile, output);
console.log(`\nOutput written to: ${outputFile}`);
